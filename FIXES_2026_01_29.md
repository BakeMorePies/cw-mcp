# MCP Fixes - January 29, 2026

## Issues Fixed

### 1. **Error Details Being Discarded** ðŸš¨

**Problem:**
When Cloudways API returned validation errors (422), the MCP was only showing:
```json
{"status": "error", "message": "HTTP error: 422"}
```

The actual error details explaining WHY it failed were being thrown away!

**Root Cause:**
In `utils/api_client.py`, both GET and POST error handlers only captured the HTTP status code, not the response body containing detailed error messages.

**Fix:**
Updated error handling to capture and return full error details:

```python
# BEFORE:
return {"status": "error", "message": f"HTTP error: {e.response.status_code}"}

# AFTER:
return {
    "status": "error",
    "message": f"HTTP error: {e.response.status_code}",
    "details": error_details,  # Now includes actual Cloudways error message!
    "endpoint": endpoint
}
```

**Impact:**
- Now you can see EXACTLY why API calls fail
- Better debugging for 422 validation errors
- Detailed error messages help identify missing/invalid parameters

---

### 2. **git_pull Missing Optional Parameters**

**Problem:**
The `git_pull` tool only sent `server_id` and `app_id`, but Cloudways API might need:
- Branch name
- Git repository URL
- Deploy path

**Root Cause:**
`git_pull` function was too simple compared to `git_clone`, which has all optional parameters.

**Fix:**
Enhanced `git_pull` to accept optional parameters:

```python
class GitPullParam(BaseModel):
    server_id: Optional[int]
    app_id: int
    branch: Optional[str]  # NEW!
    git_url: Optional[str]  # NEW!

# Can now specify branch:
git_pull({
    "params": {
        "server_id": 1488277,
        "app_id": 6176552,
        "branch": "main"  # Specify which branch to pull
    }
})
```

**Impact:**
- More control over git deployments
- Can specify branch if needed
- Better compatibility with Cloudways API requirements

---

## Files Changed

1. **`utils/api_client.py`**
   - Line 74-90: Enhanced GET request error handling
   - Line 117-132: Enhanced POST request error handling
   - Both now capture and return detailed error information

2. **`tools/security.py`**
   - Line 318-333: Enhanced `git_pull` function
   - Added `GitPullParam` model with optional branch/git_url
   - Better documentation with examples

---

## How to Deploy These Fixes

### Option 1: Local Development (Testing)
```bash
cd '/Users/bakemorepies/Local Sites/mcp-server/cloudways-mcp'

# Commit the changes
git add utils/api_client.py tools/security.py
git commit -m "Fix: Capture detailed error messages and enhance git_pull parameters

- Error handlers now return full Cloudways API error details
- git_pull now accepts optional branch and git_url parameters
- Better debugging for 422 validation errors"

# Push to your fork
git push origin main
```

### Option 2: Production Deployment
If this MCP is deployed as a service:

```bash
# SSH to MCP server
cd /path/to/cloudways-mcp

# Pull latest changes
git pull origin main

# Restart the MCP server
# (method depends on how you're running it)
pm2 restart cloudways-mcp
# OR
systemctl restart cloudways-mcp
# OR
./deploy.sh
```

---

## Testing the Fixes

### Test 1: See Detailed Error Messages
```typescript
// Try git_pull again
const result = await git_pull({
    params: {
        server_id: 1488277,
        app_id: 6176552
    }
});

// BEFORE fix:
// {"status": "error", "message": "HTTP error: 422"}

// AFTER fix:
// {
//   "status": "error", 
//   "message": "HTTP error: 422",
//   "details": {
//     "branch": ["Branch not configured"],
//     "git_url": ["Repository URL missing"]
//   },
//   "endpoint": "/git/pull"
// }
```

### Test 2: Use Optional Parameters
```typescript
// Now you can specify branch
const result = await git_pull({
    params: {
        server_id: 1488277,
        app_id: 6176552,
        branch: "main"  // Explicitly specify branch
    }
});
```

---

## Why git_pull Was Failing

Based on these fixes, the 422 error was likely because:

**Most Probable:**
1. **Missing branch parameter** - Cloudways might require branch even though it's "configured"
2. **No new commits** - But error message was hidden so we couldn't tell
3. **Git operation in progress** - Another deploy was running
4. **App not fully configured** - Missing some git setup

**Now you'll know exactly which one!** The error details will tell you.

---

## Future Enhancements

Consider adding:

1. **Retry Logic**
   ```python
   # If 422 due to "operation in progress", wait and retry
   ```

2. **Pre-flight Checks**
   ```python
   # Check if git is configured before calling git_pull
   # Check if there are new commits before deploying
   ```

3. **Better Error Messages**
   ```python
   # Parse common errors and give actionable suggestions
   if "operation in progress" in error:
       return "Another deployment is running. Wait 2 minutes and try again."
   ```

4. **Operation Status Polling**
   ```python
   # After git_pull, automatically poll operation status
   # Return when deployment completes
   ```

---

## Testing Checklist

- [ ] MCP server restarted with new code
- [ ] Try `git_pull` without branch parameter
- [ ] Check error message is detailed (not just "422")
- [ ] Try `git_pull` WITH branch parameter
- [ ] Verify it works or shows better error
- [ ] Document any new insights from error details

---

## Impact on Existing Tools

**No Breaking Changes!**
- All existing tool calls still work
- Just returning MORE information now
- Backward compatible with all clients

---

## Notes for CLOUDWAYS_MCP_ENHANCEMENT_PLAN.md

Add these completed items:

âœ… **Enhanced Error Handling**
- Capture full Cloudways API error details
- Return detailed validation errors
- Better debugging for all API calls

âœ… **Improved git_pull Tool**
- Added optional branch parameter
- Added optional git_url parameter
- Better documentation with examples

---

**Created:** January 29, 2026  
**Author:** Zara (AI Assistant)  
**Tested:** Not yet - awaiting deployment
**Status:** Ready to deploy
